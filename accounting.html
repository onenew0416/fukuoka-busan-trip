<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¨˜å¸³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ç¶ è‰²ä¸»é¡Œ */
        .text-custom-green { color: rgb(0, 140, 0); }
        .bg-custom-green { background-color: rgb(0, 140, 0); }
        .bg-gradient-custom { background: linear-gradient(135deg, rgb(0, 140, 0) 0%, rgb(0, 100, 0) 100%); }

        /* Modal å‹•ç•« */
        .modal-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é …ç›®å¡ç‰‡äº’å‹•æ¨£å¼ */
        .item-card { transition: background-color 0.2s; cursor: pointer; }
        .item-card:active { background-color: #f0fdf4; } /* é»æ“Šæ™‚çš„æŒ‰å£“æ„Ÿ */
        
        /* æ“ä½œå€å¡Šå‹•ç•« */
        .action-area { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }
        .item-card.active .action-area {
            max-height: 100px; /* è¶³å¤ å®¹ç´æŒ‰éˆ•çš„é«˜åº¦ */
            opacity: 1;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #e2e8f0;
        }
        
        /* æ—‹è½‰ç®­é ­ */
        .chevron-icon { transition: transform 0.3s; }
        .item-card.active .chevron-icon { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-green-50 text-slate-800 pb-32">

    <div class="p-6 pt-10 flex justify-between items-end">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">æ—…éŠè¨˜å¸³ <i class="fas fa-wallet text-custom-green"></i></h1>
        </div>
        <div class="text-right">
            <div class="text-[10px] text-slate-400">é è¨­åŒ¯ç‡åŸºæº–</div>
            <div class="text-xs text-slate-500 font-bold">1 TWD â‰ˆ 5 JPY â‰ˆ 47 KRW</div>
        </div>
    </div>

    <div class="mx-4 mb-6 p-5 bg-gradient-custom rounded-3xl shadow-lg shadow-green-200 text-white relative overflow-hidden">
        <div class="relative z-10">
            <div class="text-xs text-green-100 mb-1">é ä¼°ç¸½èŠ±è²» (TWD)</div>
            <div class="text-3xl font-bold tracking-wider" id="grand-total">è¨ˆç®—ä¸­...</div>
            <div class="mt-4 flex space-x-4 text-xs text-green-100/80 border-t border-white/20 pt-3">
                <div>
                    <span class="block text-[10px] opacity-70">æ—¥å¹£ç¸½è¨ˆ</span>
                    <span class="font-bold text-sm" id="total-jpy">Â¥0</span>
                </div>
                <div>
                    <span class="block text-[10px] opacity-70">éŸ“å…ƒç¸½è¨ˆ</span>
                    <span class="font-bold text-sm" id="total-krw">â‚©0</span>
                </div>
                <div>
                    <span class="block text-[10px] opacity-70">å°å¹£ç¸½è¨ˆ</span>
                    <span class="font-bold text-sm" id="total-twd">$0</span>
                </div>
            </div>
        </div>
        <i class="fas fa-coins absolute -right-4 -bottom-4 text-8xl text-white/10"></i>
    </div>

    <div id="accounting-container" class="px-4 space-y-6">
        </div>

    <div id="add-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-[90%] max-w-sm rounded-3xl p-6 shadow-2xl modal-enter">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800">æ–°å¢æ”¯å‡º</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <form id="add-form" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="input-id">
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">æ­¸å±¬å¤©æ•¸</label>
                        <select id="input-day" class="w-full bg-slate-100 rounded-xl px-4 py-3 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-custom-green appearance-none">
                            <option value="pre">è¡Œå‰æº–å‚™</option>
                            <option value="day1">Day 1 (02/24)</option>
                            <option value="day2">Day 2 (02/25)</option>
                            <option value="day3">Day 3 (02/26)</option>
                            <option value="day4">Day 4 (02/27)</option>
                            <option value="day5">Day 5 (02/28)</option>
                            <option value="day6">Day 6 (03/01)</option>
                            <option value="day7">Day 7 (03/02)</option>
                            <option value="day8">Day 8 (03/03)</option>
                            <option value="day9">Day 9 (03/04)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">é …ç›®åç¨±</label>
                        <input type="text" id="input-title" placeholder="ä¾‹å¦‚ï¼šæ©Ÿç¥¨ã€æ™šé¤" required class="w-full bg-slate-100 rounded-xl px-4 py-3 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-custom-green">
                    </div>

                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-500 mb-1">é‡‘é¡</label>
                            <input type="number" id="input-amount" placeholder="0" required class="w-full bg-slate-100 rounded-xl px-4 py-3 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-custom-green text-right">
                        </div>
                        <div class="w-1/3">
                            <label class="block text-xs font-bold text-slate-500 mb-1">å¹£åˆ¥</label>
                            <select id="input-currency" class="w-full bg-slate-100 rounded-xl px-2 py-3 font-bold text-slate-700 outline-none focus:ring-2 focus:ring-custom-green appearance-none text-center">
                                <option value="TWD">TWD</option>
                                <option value="JPY">JPY</option>
                                <option value="KRW">KRW</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="w-full bg-custom-green text-white font-bold py-3 rounded-xl mt-6 shadow-lg shadow-green-300 active:scale-95 transition-transform hover:bg-[#008c00]">
                    ç¢ºèªå„²å­˜
                </button>
            </form>
        </div>
    </div>

    <button onclick="openModal()" class="fixed bottom-24 right-6 w-14 h-14 bg-custom-green text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-110 transition z-40 active:scale-95 shadow-green-200">
        <i class="fas fa-plus"></i>
    </button>

    <div class="fixed bottom-6 left-4 right-4 bg-white rounded-full shadow-2xl py-3 px-6 flex justify-between items-center z-50">
        <a href="index.html" class="flex flex-col items-center text-slate-400 hover:text-custom-green cursor-pointer w-1/3">
            <i class="fas fa-suitcase text-lg mb-1"></i>
            <span class="text-[10px]">è¡Œç¨‹</span>
        </a>
        <div class="flex flex-col items-center text-custom-green cursor-pointer w-1/3">
            <i class="fas fa-wallet text-lg mb-1"></i>
            <span class="text-[10px] font-bold">è¨˜å¸³</span>
        </div>
        <a href="shopping.html" class="flex flex-col items-center text-slate-400 hover:text-custom-green cursor-pointer w-1/3">
            <i class="fas fa-shopping-bag text-lg mb-1"></i>
            <span class="text-[10px]">è³¼ç‰©</span>
        </a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ è«‹æ›¿æ›æˆæ‚¨çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA866R1dunG70pNX91BhvIVortnlB5QuHU",
            authDomain: "fukuoka-busan-trip.firebaseapp.com",
            projectId: "fukuoka-busan-trip",
            storageBucket: "fukuoka-busan-trip.firebasestorage.app",
            messagingSenderId: "130540342304",
            appId: "1:130540342304:web:f4a3f225ab3f2b37f00045",
            measurementId: "G-XDV9S0066R"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const RATES = {
            JPY: 0.20,   
            KRW: 0.021,  
            TWD: 1
        };

        let accountingData = [];

        async function loadData() {
            try {
                const q = query(collection(db, "expenses"), orderBy("created_at", "desc"));
                const snapshot = await getDocs(q);
                
                accountingData = [];
                snapshot.forEach(doc => {
                    accountingData.push({ id: doc.id, ...doc.data() });
                });

                renderAll();
                calculateTotal();
            } catch (e) {
                console.error("è®€å–å¤±æ•—:", e);
            }
        }

        function renderAll() {
            const container = document.getElementById('accounting-container');
            container.innerHTML = '';

            const sections = [
                { key: 'pre', name: 'è¡Œå‰æº–å‚™' },
                { key: 'day1', name: 'Day 1 (02/24)' },
                { key: 'day2', name: 'Day 2 (02/25)' },
                { key: 'day3', name: 'Day 3 (02/26)' },
                { key: 'day4', name: 'Day 4 (02/27)' },
                { key: 'day5', name: 'Day 5 (02/28)' },
                { key: 'day6', name: 'Day 6 (03/01)' },
                { key: 'day7', name: 'Day 7 (03/02)' },
                { key: 'day8', name: 'Day 8 (03/03)' },
                { key: 'day9', name: 'Day 9 (03/04)' }
            ];

            sections.forEach(sec => {
                const items = accountingData.filter(d => d.day === sec.key);
                
                let subTWD = 0, subJPY = 0, subKRW = 0;
                items.forEach(i => {
                    const amt = parseFloat(i.amount);
                    if(i.currency === 'TWD') subTWD += amt;
                    if(i.currency === 'JPY') subJPY += amt;
                    if(i.currency === 'KRW') subKRW += amt;
                });

                // ä¿®æ”¹ï¼šæ”¹æˆå¡ç‰‡å¼çµæ§‹ï¼ŒåŒ…å«éš±è—çš„æ“ä½œæŒ‰éˆ•
                let itemsHtml = items.map(item => `
                    <div id="item-${item.id}" class="item-card py-3 border-b border-slate-50 last:border-0" onclick="toggleItem('${item.id}')">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="text-sm font-medium text-slate-700 flex items-center gap-2">
                                    ${item.title}
                                    <i class="fas fa-chevron-down text-[10px] text-slate-300 chevron-icon"></i>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-slate-800">${formatCurrency(item.amount)} <span class="text-[10px] text-slate-400">${item.currency}</span></div>
                            </div>
                        </div>
                        
                        <div class="action-area flex gap-3">
                            <button onclick="event.stopPropagation(); editItem('${item.id}')" class="flex-1 bg-green-100 text-green-700 py-2 rounded-lg text-sm font-bold hover:bg-green-200 active:scale-95 transition">
                                <i class="fas fa-pen mr-1"></i> ç·¨è¼¯
                            </button>
                            <button onclick="event.stopPropagation(); deleteItem('${item.id}')" class="flex-1 bg-red-100 text-red-600 py-2 rounded-lg text-sm font-bold hover:bg-red-200 active:scale-95 transition">
                                <i class="fas fa-trash mr-1"></i> åˆªé™¤
                            </button>
                        </div>
                    </div>
                `).join('');

                const html = `
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-slate-50 px-5 py-3 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800 text-sm">${sec.name}</h3>
                            <button onclick="openModal('${sec.key}')" class="text-slate-400 hover:text-custom-green text-xs"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="p-4 pt-2 pb-2">
                            ${itemsHtml || '<div class="text-center text-xs text-slate-300 py-4">å°šç„¡æ”¯å‡º</div>'}
                        </div>
                        <div class="bg-green-50/50 px-5 py-2 flex justify-end space-x-4 text-xs border-t border-slate-100">
                            ${subTWD > 0 ? `<span class="font-bold text-slate-600">TWD ${formatNumber(subTWD)}</span>` : ''}
                            ${subJPY > 0 ? `<span class="font-bold text-blue-600">JPY ${formatNumber(subJPY)}</span>` : ''}
                            ${subKRW > 0 ? `<span class="font-bold text-purple-600">KRW ${formatNumber(subKRW)}</span>` : ''}
                            ${(subTWD+subJPY+subKRW) === 0 ? '<span class="text-slate-300">--</span>' : ''}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // æ–°å¢ï¼šåˆ‡æ›å¡ç‰‡å±•é–‹ç‹€æ…‹
        window.toggleItem = function(id) {
            // å…ˆé—œé–‰å…¶ä»–çš„ (å¦‚æœæƒ³ä¸€æ¬¡åªèƒ½é–‹ä¸€å€‹)
            const allItems = document.querySelectorAll('.item-card');
            allItems.forEach(el => {
                if (el.id !== `item-${id}`) {
                    el.classList.remove('active');
                }
            });

            const el = document.getElementById(`item-${id}`);
            if (el) {
                el.classList.toggle('active');
            }
        }

        function calculateTotal() {
            let totalTWD = 0;
            let sumJPY = 0, sumKRW = 0, sumTWD = 0;

            accountingData.forEach(item => {
                const amt = parseFloat(item.amount);
                if (item.currency === 'TWD') {
                    totalTWD += amt;
                    sumTWD += amt;
                } else if (item.currency === 'JPY') {
                    totalTWD += amt * RATES.JPY;
                    sumJPY += amt;
                } else if (item.currency === 'KRW') {
                    totalTWD += amt * RATES.KRW;
                    sumKRW += amt;
                }
            });

            document.getElementById('grand-total').innerText = 'NT$ ' + formatNumber(Math.round(totalTWD));
            document.getElementById('total-jpy').innerText = 'Â¥ ' + formatNumber(sumJPY);
            document.getElementById('total-krw').innerText = 'â‚© ' + formatNumber(sumKRW);
            document.getElementById('total-twd').innerText = '$ ' + formatNumber(sumTWD);
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function formatCurrency(num) {
            return formatNumber(parseFloat(num));
        }

        window.handleFormSubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('input-id').value;
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerText = 'è™•ç†ä¸­...';

            const newItem = {
                day: document.getElementById('input-day').value,
                title: document.getElementById('input-title').value,
                amount: parseFloat(document.getElementById('input-amount').value),
                currency: document.getElementById('input-currency').value,
                created_at: Date.now()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, "expenses", id), newItem);
                } else {
                    await addDoc(collection(db, "expenses"), newItem);
                }
                await loadData();
                closeModal();
            } catch (e) {
                console.error(e);
                alert('å„²å­˜å¤±æ•—');
            } finally {
                btn.disabled = false; btn.innerText = 'ç¢ºèªå„²å­˜';
            }
        }

        // ä¿®æ”¹ï¼šå³æ™‚åˆªé™¤é‚è¼¯
        window.deleteItem = async function(id) {
            if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†æ”¯å‡ºï¼Ÿ')) return;
            
            // 1. ç«‹å³å¾ç•«é¢ä¸Šç§»é™¤ (Optimistic UI)
            const itemElement = document.getElementById(`item-${id}`);
            if (itemElement) {
                // åŠ ä¸Šæ·¡å‡ºæ•ˆæœ
                itemElement.style.transition = 'all 0.3s';
                itemElement.style.opacity = '0';
                itemElement.style.height = '0';
                itemElement.style.padding = '0';
                setTimeout(() => itemElement.remove(), 300);
            }

            // 2. èƒŒæ™¯åŸ·è¡Œè³‡æ–™åº«åˆªé™¤
            try {
                await deleteDoc(doc(db, "expenses", id));
                // 3. é‡æ–°è®€å–ä»¥ç¢ºä¿é‡‘é¡è¨ˆç®—æ­£ç¢º (ä½¿ç”¨è€…é€™æ™‚å€™å·²ç¶“çœ‹åˆ°é …ç›®æ¶ˆå¤±äº†)
                await loadData();
            } catch (e) { 
                console.error(e); 
                alert("åˆªé™¤å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ");
                loadData(); // å¤±æ•—çš„è©±æŠŠè³‡æ–™æ‹‰å›ä¾†
            }
        }

        window.editItem = function(id) {
            const item = accountingData.find(i => i.id === id);
            if(item) {
                document.getElementById('input-id').value = item.id;
                document.getElementById('input-day').value = item.day;
                document.getElementById('input-title').value = item.title;
                document.getElementById('input-amount').value = item.amount;
                document.getElementById('input-currency').value = item.currency;
                
                document.getElementById('modal-title').innerText = 'ç·¨è¼¯æ”¯å‡º';
                document.getElementById('add-modal').classList.remove('hidden');
            }
        }

        window.openModal = function(dayKey = 'day1') {
            document.getElementById('add-form').reset();
            document.getElementById('input-id').value = '';
            document.getElementById('input-day').value = dayKey;
            document.getElementById('modal-title').innerText = 'æ–°å¢æ”¯å‡º';
            document.getElementById('add-modal').classList.remove('hidden');
        }
        
        window.closeModal = function() { document.getElementById('add-modal').classList.add('hidden'); }
        document.getElementById('add-modal').addEventListener('click', function(e){if(e.target===this)closeModal()});

        loadData();

    </script>
</body>
</html>